# Скрипт тестирования производительности вывода глубоких моделей

## Описание

### Основная информация

Скрипт тестирования производительности позволяет тестировать производительность
вывода глубоких моделей с использованием разных фреймверков для вывода.

В данный момент поддерживается вывод при помощи следующих фреймверков:
- OpenVINO DLDT
- Intel Caffe

### Работа скрипта тестирования производительности

На вход скрипту подаются конфигурации тестов. Описание конфигурации 
тестов можно посмотреть [здесь](../configs/README.md).
Тест представляет собой запуск вывода с параметрами, переданными в конфигурации.
Для каждой переданой конфигурации проводится соответвующий тест.
Тесты проводятся последовательно. Каждый тест запускается в отдельном процессе.

### Результаты работы скрипта тестирования производительности

Результатом теста являются метрики производительности вывода для параметров,
переданных в конфигурации. Результаты записываются в результирующий файл
(csv-таблица).

## Показатели производительности

### Показатели производительности OpenVINO DLDT

**Синхронный и асинхронный режимы вывода**

Intel® Distribution of OpenVINO™ toolkit предусматривает два режима вывода
глубоких нейросетевых моделей.
1. **Синхронный режим.** Предполагает создание и запуск одного запроса
на вывод модели на выбранном устройстве. Каждый следующий запрос
на вывод создается по завершении предыдущего. При реализации
количество создаваемых запросов определяется числом итераций цикла
тестирования модели.
2. **Асинхронный режим.** Предусматривает возможность создания набора
запросов на вывод на выбранном устройстве. Порядок завершения запросов
в простейшем случае соответствует последовательности их создания,
а для некоторых задач - определяется структурой модели и сложностью
входных данных. Количество создаваемых наборов определяется числом
итераций цикла тестирования модели.

Следует отметить, что один запрос на вывод предполагает прямой проход
нейронной сети для "пачки" изображений. Размер "пачки" в запросе,
количество итераций цикла тестирования, количество создаваемых запросов
в асинхронном режиме являются параметрами вывода.


**Показатели производительности для синхронного режима**

При оценке производительности вывода для синхронного режима
осуществляется последовательный и независимый запуск запросов.
Запуск очередного запроса выполняется после завершения предыдущего.
Для каждого запроса осуществляется замер времени его выполнения.
Для множества полученных времен определяется стандартное среднеквадратичное
отклонение, и отбрасываются времена, выходящие за пределы трех стандартных
отклонений от среднего времени вывода. Результирующий набор времен
используется для вычисления показателя латентности. Остальные показатели
вычисляются для всего множества времен.
- **Латентность (latency)** - медиана множества времен выполнения вывода.
- **Среднее время одного прохода (average time of single pass)** - отношение
  общего времени выполнения всех запросов к числу запросов.
- **Количество кадров, обрабатываемых за секунду (frames per second, FPS)** -
  отношение размера обрабатываемой “пачки” изображений к среднему времени
  одного прохода.

**Показатели производительности для асинхронного режима**

- **Среднее время одного прохода (average time of single pass)** -
  отношение времени выполнения всех наборов запросов к числу
  итераций цикла тестирования. Характеризует время выполнения набора
  одновременно созданных запросов на устройстве.
- **Количество кадров, обрабатываемых за секунду (frames per second, FPS)** -
  отношение произведения размера обрабатываемой "пачки" и числа итераций
  к общему времени выполнения всех запросов.

### Показатели производительности Intel Caffe

При оценке производительности вывода для Intel Caffe
осуществляется последовательный и независимый запуск запросов.
Запуск очередного запроса выполняется после завершения предыдущего.
Для каждого запроса осуществляется замер времени его выполнения.
Для множества полученных времен определяется стандартное среднеквадратичное
отклонение, и отбрасываются времена, выходящие за пределы трех стандартных
отклонений от среднего времени вывода. Результирующий набор времен
используется для вычисления показателя латентности. Остальные показатели
вычисляются для всего множества времен.
- **Латентность (latency)** - медиана множества времен выполнения вывода.
- **Среднее время одного прохода (average time of single pass)** - отношение
  общего времени выполнения всех запросов к числу запросов.
- **Количество кадров, обрабатываемых за секунду (frames per second, FPS)** -
  отношение размера обрабатываемой “пачки” изображений к среднему времени
  одного прохода.

## Использование скрипта тестирования производительности

Параметры скрипта:
- `-с / --config <benchmark_configuration.xml>` - путь до файла конфигурации,
  содержащего информацию о проводимых тестах.
- `-r / --result <results.csv>` - имя результирующего файла с форматом.
- `--executor_type` - окружение для запуска скрипта тестирования производительности.
  Доступные значения `host_machine` - запуск в текущем окружении и 
  `docker_container` - запуск в соответсвующем докер контейнере.

Запуск в текущем окружении:
```bash
python inference_benchmark.py \
    -r results.csv -c C:/benchmark_configuration.xml \
    --executor_type host_machine
```

Запуск в докер контейнере:
```bash
python inference_benchmark.py \
    -r results.csv -c C:/benchmark_configuration.xml \
    --executor_type docker_container
```